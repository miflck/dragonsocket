<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Drawing Canvas (Backend)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family: Arial, sans-serif;
        background-color: #f0f0f0;
        /* Prevent mobile drag/scroll */
        touch-action: pan-x pan-y;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      h1 {
        text-align: center;
        color: #333;
      }
      #canvasContainer {
        display: flex;
        justify-content: center;
        margin-top: 20px;
        /* Prevent canvas area from being draggable */
        touch-action: none;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
      .info {
        text-align: center;
        margin-bottom: 20px;
        color: #666;
      }
      /* Prevent selection and dragging on canvas */
      canvas {
        touch-action: none !important;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
      }
    </style>
  </head>
  <body>
    <h1>Drawing Canvas (Backend)</h1>
    <div class="info">
      <p>Draw on the canvas below. You won't see other users' drawings here.</p>
      <p>View all drawings at: <a href="/display" target="_blank">/display</a></p>
    </div>
    <div id="canvasContainer"></div>

    <script>
      let socket;
      let drawing = false;
      let prevX, prevY;
      let lastMouseX = -1;
      let lastMouseY = -1;
      let myColor = "#000000"; // Default color until server assigns one
      let canvasSettings = { width: 800, height: 600, backgroundColor: "#FFFFFF" };
      let drawingSettings = { strokeWeight: 3 };
      let uiSettings = { showClientIds: true };

      function setup() {
        // Create canvas using default settings first
        let canvas = createCanvas(canvasSettings.width, canvasSettings.height);
        canvas.parent("canvasContainer");

        // Set background - convert hex to P5.js format
        background(canvasSettings.backgroundColor);

        // Prevent default touch behavior on canvas
        canvas.elt.addEventListener(
          "touchstart",
          function (e) {
            e.preventDefault();
          },
          { passive: false }
        );

        canvas.elt.addEventListener(
          "touchmove",
          function (e) {
            e.preventDefault();
          },
          { passive: false }
        );

        canvas.elt.addEventListener(
          "touchend",
          function (e) {
            e.preventDefault();
          },
          { passive: false }
        );

        // Initialize socket connection
        socket = io();

        // Listen for assigned color and settings from server
        socket.on("assigned-color", (data) => {
          myColor = data.color;

          // Update settings from server if provided
          if (data.canvasSettings) {
            canvasSettings = data.canvasSettings;
            // Resize canvas if settings changed
            resizeCanvas(canvasSettings.width, canvasSettings.height);
            background(canvasSettings.backgroundColor);
          }
          if (data.drawingSettings) {
            drawingSettings = data.drawingSettings;
          }
          if (data.uiSettings) {
            uiSettings = data.uiSettings;
          }

          console.log("Assigned color:", myColor);
          console.log("Canvas settings:", canvasSettings);

          // Update page background to show assigned color
          document.body.style.borderTop = `5px solid ${myColor}`;
        });

        console.log("Drawing canvas initialized");
      }

      function mouseMoved() {
        // Only send cursor position if mouse actually moved and is within canvas
        if (mouseX >= 0 && mouseX <= width && mouseY >= 0 && mouseY <= height) {
          if (mouseX !== lastMouseX || mouseY !== lastMouseY) {
            socket.emit("cursor-position", {
              x: mouseX,
              y: mouseY,
            });
            lastMouseX = mouseX;
            lastMouseY = mouseY;
          }
        }
      }

      function mousePressed() {
        if (mouseX >= 0 && mouseX <= width && mouseY >= 0 && mouseY <= height) {
          drawing = true;
          prevX = mouseX;
          prevY = mouseY;
        }
      }

      function mouseDragged() {
        if (drawing && mouseX >= 0 && mouseX <= width && mouseY >= 0 && mouseY <= height) {
          // Draw locally with assigned color and settings
          stroke(myColor);
          strokeWeight(drawingSettings.strokeWeight);
          line(prevX, prevY, mouseX, mouseY);

          // Send drawing data to server (server will add clientId and color)
          socket.emit("drawing", {
            x1: prevX,
            y1: prevY,
            x2: mouseX,
            y2: mouseY,
            weight: drawingSettings.strokeWeight,
          });

          // Update previous position
          prevX = mouseX;
          prevY = mouseY;
        }
      }

      function mouseReleased() {
        drawing = false;
      }

      // Handle clear canvas
      function keyPressed() {
        // Clear canvas on spacebar
        if (key === " ") {
          background(canvasSettings.backgroundColor);
          socket.emit("clear");
        }
      }

      // Handle touch events for mobile
      function touchMoved() {
        // Send cursor position for touch
        if (mouseX >= 0 && mouseX <= width && mouseY >= 0 && mouseY <= height) {
          if (mouseX !== lastMouseX || mouseY !== lastMouseY) {
            socket.emit("cursor-position", {
              x: mouseX,
              y: mouseY,
            });
            lastMouseX = mouseX;
            lastMouseY = mouseY;
          }

          // Handle drawing on touch drag
          if (drawing) {
            stroke(myColor);
            strokeWeight(drawingSettings.strokeWeight);
            line(prevX, prevY, mouseX, mouseY);

            socket.emit("drawing", {
              x1: prevX,
              y1: prevY,
              x2: mouseX,
              y2: mouseY,
              weight: drawingSettings.strokeWeight,
            });

            prevX = mouseX;
            prevY = mouseY;
          }
        }
        // Prevent default scrolling behavior
        return false;
      }

      function touchStarted() {
        // Only handle touch if within canvas
        if (mouseX >= 0 && mouseX <= width && mouseY >= 0 && mouseY <= height) {
          drawing = true;
          prevX = mouseX;
          prevY = mouseY;
          return false; // Prevent default
        }
      }

      function touchEnded() {
        drawing = false;
        return false; // Prevent default
      }
    </script>
  </body>
</html>
